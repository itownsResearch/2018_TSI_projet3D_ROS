<!DOCTYPE html>
<html>
    <head>
        <title>Ros visualization example</title>

        <style type="text/css">
            html {
                height: 100%;
            }

            body {
                margin: 0;
                overflow:hidden;
                height:100%;
            }


            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                display: none;
            }

        </style>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv"></div>
        <div id="info"></div>

        <div class="centered">
            <div id="itowns"> </div>

            <script src="dat.gui.min.js"></script>
            <script src="https://github.com/iTowns/itowns/releases/download/v2.3.0/itowns.js"></script>
            <script>
              var THREE = itowns.THREE;
            </script>
            <script src="https://cdn.jsdelivr.net/npm/eventemitter2@5.0.1/lib/eventemitter2.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/0.20.0/roslib.min.js"></script>
            <script src="https://rawgit.com/RoseMathelier/ros3djs/7c14762e9d06a8c012333057a627e6225430b80b/build/ros3d.min.js"></script>

            <script type="text/javascript">

            //http://static.robotwebtools.org/ros3djs/current/ros3d.min.js
            //https://raw.githubusercontent.com/RoseMathelier/ros3djs/develop/src/Ros3D.js

              console.log("showRosData");
              //var ros;
              var pointclouds = [];
              var oldPostUpdate;
              var viewerDiv;
              var view;
              var controls;
              var cameraPositioned = false;
              var listCoords = [];
              var lineId = 0;

              viewerDiv = document.getElementById('viewerDiv');
              viewerDiv.style.display = 'block';

              itowns.THREE.Object3D.DefaultUp.set(0, 0, 1);

              itowns.proj4.defs('EPSG:3946',
                  '+proj=lcc +lat_1=45.25 +lat_2=46.75 +lat_0=46 +lon_0=3 +x_0=1700000 ' +
                  '+y_0=5200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

              view = new itowns.View('EPSG:3946', viewerDiv, { renderer: { logarithmicDepthBuffer: true } });
              view.mainLoop.gfxEngine.renderer.setClearColor(0x555555);
              controls = new itowns.FlyControls(view, { focusOnClick: true });

              //ROS initialization
              var ros = new ROSLIB.Ros({
                        url : 'wss://localhost:9090/'
                      });

              var tfClient = new ROSLIB.TFClient({
                    ros : ros,
                    fixedFrame : '/l93',
                    angularThres : 0.01,
                    transThres : 0.01,
                    rate : 10.0,
                  });

              ros.on('connection', function() {
                  console.log('Connected to websocket server.');
              });

              ros.on('error', function(error) {
                  console.log('Error connecting to websocket server: ', error);
              });

              ros.on('close', function() {
                  console.log('Connection to websocket server closed.');
              });
              console.log(ros);
              
              //GUI interface : topic displayed
              var gui = new dat.GUI();

              //Get the available topics
              ros.getTopics(handleTopics);

              function handleTopics(json){
                console.log(json);
                var params = {};
                var type;
                var controllers = {};

                var folders = {};
                json.topics.forEach((topicName, index) => {
                  type = json.types[index];
                  params[topicName] = false;

                  
                  //Topic creation
                  var client;
                  var options = {
                    ros: ros,
                    topic: topicName,
                    tfClient: tfClient,
                    rootObject: view.scene,
                    color: 0xcc00ff,
                    handler : {
                        'sensor_msgs/NavSatFix' : handleNavSatFix,
                        //'geometry_msgs/PoseWithCovarianceStamped' : handlePWCS,
                    }
                  };
                  switch(type){
                    case 'tf2_msgs/TFMessage' : return; // TFClient is handling it already
                    case 'sensor_msgs/PointCloud2': 
                      options.size = 0.05;
                      options.max_pts = 100000;
                      client = new ROS3D.PointCloud2(options);
                      break;
                    case 'nav_msgs/Path': client = new ROS3D.Path(options); break;
                    case 'visualization_msgs/InteractiveMarkerUpdate' : client = new ROS3D.InteractiveMarkerClient(options); break;
                    case 'visualization_msgs/MarkerArray' : client = new ROS3D.MarkerArrayClient(options); break;
                    case 'visualization_msgs/Marker' : client = new ROS3D.MarkerClient(options); break;
                    case 'nav_msgs/OccupancyGrid' : client = new ROS3D.OccupancyGridClient(options); break;
                    case 'nav_msgs/Odometry' : client = new ROS3D.Odometry(options); break;
                    case 'geometry_msgs/PointStamped' : client = new ROS3D.Point(options); break;
                    case 'geometry_msgs/PolygonStamped' : client = new ROS3D.Polygon(options); break;
                    case 'geometry_msgs/PoseStamped' : client = new ROS3D.Pose(options); break;
                    case 'geometry_msgs/PoseArray' : client = new ROS3D.PoseArray(options); break;
                    case 'geometry_msgs/PoseWithCovarianceStamped' : client = new ROS3D.PoseWithCovariance(options); break;
                    case 'sensor_msgs/LaserScan' : client = new ROS3D.LaserScan(options); break;
                    case '???' : client = new ROS3D.UrdfClient(options); break;
                    default :
                        var handler = options.handler[type] || console.log;
                        client = {
                            topic : new ROSLIB.Topic({
                                ros : ros,
                                name : topicName,
                                messageType : type
                            }),
                            subscribe : function() { this.topic.subscribe(handler); },
                            unsubscribe : function() { this.topic.unsubscribe(); },
                        };
                    }
                    client.unsubscribe();
                  
                  // Create the controller and type hierarchy
                  var folder = gui;
                  type.split("/").forEach(name => {folder = folder.__folders[name] || folder.addFolder(name); });
                  controllers[topicName] = folder.add(params, topicName).onFinishChange(checked => {
                    if(checked) { client.subscribe() } else { client.unsubscribe(); }
                  });

                });

              }
/*
              function handlePWCS(message){

                //Get data position from the message
                var position = {
                  'x' : message.pose.pose.position.x,
                  'y' : message.pose.pose.position.y,
                  'z' : message.pose.pose.position.z
                }

                //Get orientation from the message
                var orientation = {
                  'x' : message.pose.pose.orientation.x,
                  'y' : message.pose.pose.orientation.y,
                  'z' : message.pose.pose.orientation.z,
                  'w' : message.pose.pose.orientation.w
                }

                //Create point geometry
                var pointCam = new THREE.Geometry();
                var pointVertice = new THREE.Vector3(position.x, position.y, position.z);
                pointCam.vertices.push(pointVertice);
                var point = new THREE.Points(pointCam);

                //Add to scene
                view.scene.add(point);

                //Camera
                if(!cameraPositioned){
                  cameraPositioned = true;
                  var firstPointPos = new THREE.Vector3(position.x, position.y, position.z);
                  placeCamera(firstPointPos.clone().add(new itowns.THREE.Vector3(10,10,10)), firstPointPos);
                }

              }
*/
              function handleNavSatFix(message){
                    console.log('handleNavSatFix');
            		// Data registration
            		var coords = {'latitude':message.latitude, 'longitude':message.longitude, 'altitude':message.altitude};
            		var state = message.status;
            		var nameLin = "line" + lineId;

            		// We test the GPS quality
            		if(state.status !== -1 ){
            			listCoords.push(coords);
            		}


            		// We test if there are enough points to create a polyline
            		if(listCoords.length > 1){

            			var points3D = new THREE.Geometry();
            			points3D.vertices.push(
            			  new THREE.Vector3(listCoords[0].latitude, listCoords[0].longitude, listCoords[0].altitude),
            			  new THREE.Vector3(listCoords[1].latitude, listCoords[1].longitude, listCoords[1].altitude)
            			);
            			var line = new THREE.Line(points3D, new THREE.LineBasicMaterial({color: "red"}));

            			line.name = nameLin;

            			view.scene.add(line);
            		}


            		/*if(lineId > 10){
            			nameRem = "line"+ (lineId-10);
            			removeEntity(nameRem);
            		}*/


            		if(listCoords.length > 1){
            			listCoords.shift();
            		}

            		lineId++;

                /*
            		// Data positionning
                var geometry = new itowns.THREE.SphereGeometry( 0.5, 8, 8 );
                var material = new itowns.THREE.MeshBasicMaterial( {wireframe: true, color: 0xffff00, side: itowns.THREE.DoubleSide} );
                var sphere = new itowns.THREE.Mesh( geometry, material );

                view.scene.add( sphere );
                */

                view.camera.camera3D.fov = 80;

                //Camera
                if(!cameraPositioned){
                  cameraPositioned = true;
                  var firstPointPos = new THREE.Vector3(listCoords[0].latitude, listCoords[0].longitude, listCoords[0].altitude);
                  placeCamera(firstPointPos.clone().add(new itowns.THREE.Vector3(10,10,10)), firstPointPos);
                }
          	  }

              function placeCamera(position, lookAt) {
                  view.camera.camera3D.position.set(position.x, position.y, position.z);
                  view.camera.camera3D.lookAt(lookAt);
                  // create controls
                  controls = new itowns.FirstPersonControls(view, { focusOnClick: true });
                  //debugGui.add(controls, 'moveSpeed', 1, 100).name('Movement speed');

                  view.notifyChange(true);
              }


            </script>
    </body>
</html>
